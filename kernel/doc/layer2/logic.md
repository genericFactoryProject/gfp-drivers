这部分参考很多开源的内核。TODO。